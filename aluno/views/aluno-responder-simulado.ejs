<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Responder Simulado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, proxy-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="/assets/theme-d32f8eb8.css" />
    <style>
      /* Conteúdo principal */
      main {
        max-width: 800px;
      }
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #ccc;
        padding: 20px;
      }
      .question-card {
        margin-bottom: 20px;
      }
      .alternative-container {
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
      }
      .alternative-toggle.alternative-selected {
        background-color: rgb(79 70 229 / var(--tw-bg-opacity));
        color: #fff;
      }
      .question-index {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background: #f1f1f1;
        border-radius: 4px;
        margin-right: 10px;
      }
      footer .nav-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      .btn-enabled {
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.875rem;
        text-align: center;
        border: 1px solid #2563eb;
        background: #2563eb;
        color: #fff;
        border-radius: 0.375rem;
        transition: background-color 0.5s, border-color 0.5s;
      }
      .btn-enabled:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }
      .btn-disabled {
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.875rem;
        text-align: center;
        border: 1px solid #d1d5db;
        background: #d1d5db;
        color: #6b7280;
        border-radius: 0.375rem;
      }
      .alternative-toggle {
        flex-shrink: 0;
      }
      .alternative-text {
        padding-left: 10px;
        flex-grow: 1;
      }

      /* Sidebar colapsável */
      .sidebar-wrapper {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 200px;
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      .sidebar-wrapper.collapsed {
        transform: translateX(180px);
      }
      .sidebar {
        height: 100%;
        background: #f8f9fa;
        border-left: 1px solid #ccc;
        padding: 20px;
        overflow-y: auto;
      }
      .sidebar h3 {
        margin: 0 0 10px;
      }
      .question-map {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .question-map div {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
      }
      .question-map div.answered {
        background: #28a745;
        color: #fff;
      }
      .sidebar-toggle {
        position: absolute;
        top: 50%;
        left: -20px;
        transform: translateY(-50%);
        width: 20px;
        height: 60px;
        background: #4f46e5;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
      }
      .sidebar-toggle:hover {
        background: #4338ca;
      }

      /* Timer */
      #timer {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      /* Overlay de início */
      #startOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <!-- Overlay inicial -->
    <div id="startOverlay">
      <button
        id="startBtn"
        class="btn-enabled"
        style="font-size: 1.25rem; padding: 1rem 2rem"
      >
        Iniciar Simulado
      </button>
    </div>

    <!-- Dados ocultos -->
    <div
      id="simuladoData"
      data-total="<%= totalRows %>"
      style="display: none"
    ></div>

    <!-- Sidebar -->
    <div class="sidebar-wrapper" id="sidebarWrapper">
      <div class="sidebar-toggle" id="sidebarToggle">
        <span id="toggleIcon">❱</span>
      </div>
      <div class="sidebar">
        <h3>Mapa de Questões</h3>
        <div class="question-map">
          <% questoes.forEach(function(q,index){ %>
          <div data-question="<%= index+1 %>" data-question-id="<%= q.id %>">
            <%= index+1 %>
          </div>
          <% }); %>
        </div>
        <div style="margin-top: 20px; text-align: center">
          <form
            id="encerrarSimuladoForm"
            method="POST"
            action="/aluno/encerrar-simulado/<%=simulado.id%>"
          >
            <input type="hidden" name="answers" id="answersInput" value="" />
            <button
              type="submit"
              id="submitBtn"
              class="btn-disabled"
              style="width: 100%"
              disabled
            >
              Encerrar simulado
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="min-h-screen flex flex-col lg:ps-64 w-full">
      <main class="p-1 space-y-1">
        <div id="timer">Tempo restante: --:--:--</div>
        <div class="container">
          <% if (questoes && questoes.length>0) { var questao =
          questoes[currentPage-1]; %>
          <div
            class="question-card card-simulado shadow rounded-lg bg-white dark:bg-default-50 border"
          >
            <header class="d-flex align-items-baseline px-3 py-3">
              <div class="question-index"><%=currentPage%></div>
            </header>
            <div class="px-3 pb-3">
              <div class="mt-2">
                <div class="font-size-2"><%- questao.enunciado %></div>
                <div class="d-flex flex-column mt-3">
                  <% var alts = {A: questao.alternativa_a, B:
                  questao.alternativa_b, C: questao.alternativa_c, D:
                  questao.alternativa_d, E: questao.alternativa_e};
                  Object.keys(alts).forEach(function(key) { if (alts[key]) { %>
                  <div
                    class="alternative-container p-3 my-2"
                    data-questao="<%= questao.id %>"
                  >
                    <div
                      class="alternative-toggle text-center font-weight-bold"
                      data-alternative="<%= key %>"
                      style="
                        font-weight: bold;
                        width: 40px;
                        height: 40px;
                        line-height: 40px;
                        border: 1.5px solid
                          hsl(var(--twc-primary) / var(--tw-bg-opacity));
                        border-radius: 50%;
                      "
                    >
                      <%= key %>
                    </div>
                    <div class="alternative-text"><%= alts[key] %></div>
                  </div>
                  <% } }); %>
                </div>
              </div>
            </div>
          </div>
          <% } else { %>
          <div class="text-center text-base text-gray-700">
            Nenhuma questão encontrada.
          </div>
          <% } %>
        </div>
      </main>

      <footer>
        <div class="nav-buttons">
          <% if (currentPage > 1) { %>
          <button
            type="button"
            class="btn-custom"
            onclick="location.href='/aluno/responder-simulado/<%= simulado.id %>?page=<%= currentPage-1 %>'"
          >
            Anterior
          </button>
          <% } else { %>
          <button type="button" class="btn-custom" disabled>Anterior</button>
          <% } %> <% if (currentPage < totalPages) { %>
          <button
            type="button"
            class="btn-custom"
            onclick="location.href='/aluno/responder-simulado/<%= simulado.id %>?page=<%= currentPage+1 %>'"
          >
            Próxima
          </button>
          <% } else { %>
          <button type="button" class="btn-custom" disabled>Próxima</button>
          <% } %>
        </div>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      let examEnded = false;
      const simuladoId = "<%= simulado.id %>";
      const alunoId = "<%= aluno.id %>";
      const totalQuestions = Number(
        document.getElementById("simuladoData").getAttribute("data-total")
      );

      // Controle do overlay inicial
      const overlayKey = `overlayShown_${alunoId}_${simuladoId}`;
      const overlay = document.getElementById("startOverlay");
      if (localStorage.getItem(overlayKey)) overlay.style.display = "none";

      function enterFullScreenMode() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem
            .requestFullscreen()
            .catch((err) =>
              console.error("Erro ao entrar em tela cheia:", err)
            );
        } else if (elem.mozRequestFullScreen) {
          elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      }
      // 1) Função para criar o overlay bloqueador
      function showBlocker() {
        if (document.getElementById("fsBlocker")) return;
        const div = document.createElement("div");
        div.id = "fsBlocker";
        Object.assign(div.style, {
          position: "fixed",
          top: 0,
          left: 0,
          width: "100%",
          height: "100%",
          background: "rgba(255,255,255)",
          zIndex: 9999,
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          flexDirection: "column",
          fontSize: "1.2rem",
        });
        div.innerHTML = `
    <p>Você saiu do modo tela cheia!<br>Para continuar o simulado, clique no botão abaixo:</p>
    <button id="reenterFsBtn" style="padding:0.8rem 1.5rem;font-size:1rem;">Voltar à Tela Cheia</button>
  `;
        document.body.appendChild(div);
        document
          .getElementById("reenterFsBtn")
          .addEventListener("click", () => {
            enterFullScreenMode();
            document.body.removeChild(div);
          });
      }

      // 2) Detecta saída de fullscreen e bloqueia
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement && !examEnded) {
          showBlocker();
        }
      });

      document.getElementById("startBtn").addEventListener("click", () => {
        enterFullScreenMode();
        localStorage.setItem(overlayKey, "true");
        overlay.style.display = "none";
      });

      // Impede sair de tela cheia
      document.addEventListener("keydown", (e) => {
        if (!examEnded && (e.key === "F11" || e.key === "Escape")) {
          e.preventDefault();
          alert("Você não pode sair da tela cheia durante o simulado.");
          enterFullScreenMode();
        }
      });
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement && !examEnded) {
          alert("Você não pode sair da tela cheia durante o simulado.");
          enterFullScreenMode();
        }
      });
      ["load", "pageshow"].forEach((evt) =>
        window.addEventListener(evt, () => {
          // se o simulado já foi iniciado (overlayKey) e não estamos em fullscreen
          if (
            localStorage.getItem(overlayKey) === "true" &&
            !document.fullscreenElement &&
            !examEnded
          ) {
            showBlocker();
          }
        })
      );

      // Sidebar toggle
      const sidebarWrapper = document.getElementById("sidebarWrapper"),
        sidebarToggle = document.getElementById("sidebarToggle"),
        toggleIcon = document.getElementById("toggleIcon");
      let collapsed = localStorage.getItem("sidebarCollapsed") === "true";
      if (collapsed) {
        sidebarWrapper.classList.add("collapsed");
        toggleIcon.textContent = "❰";
      }
      sidebarToggle.addEventListener("click", () => {
        collapsed = !collapsed;
        sidebarWrapper.classList.toggle("collapsed", collapsed);
        toggleIcon.textContent = collapsed ? "❰" : "❱";
        localStorage.setItem("sidebarCollapsed", collapsed);
      });

      function timeStringToSeconds(timeString) {
        if (!timeString) return 0;
        if (timeString.includes(":")) {
          var parts = timeString.split(":");
          if (parts.length !== 3) return 0;
          return (
            parseInt(parts[0], 10) * 3600 +
            parseInt(parts[1], 10) * 60 +
            parseInt(parts[2], 10)
          );
        }
        var secs = parseInt(timeString, 10);
        return isNaN(secs) ? 0 : secs;
      }
      var examTimeInSeconds = timeStringToSeconds(
        "<%= simulado.tempo_prova %>"
      );

      // Limpa storage se for novo simulado
      (function clearSimuladoStorageIfNew() {
        var key = "aluno_" + alunoId + "_simulado_id",
          stored = localStorage.getItem(key);
        if (stored !== simuladoId) {
          Object.keys(localStorage).forEach(function (k) {
            if (k.indexOf("aluno_" + alunoId + "_simulado_") === 0)
              localStorage.removeItem(k);
          });
          localStorage.setItem(key, simuladoId);
        }
      })();

      function collectAllAnswers() {
        var answersObj = {},
          prefix = "aluno_" + alunoId + "_simulado_" + simuladoId + "_questao_";
        document
          .querySelectorAll(".sidebar .question-map div")
          .forEach(function (el) {
            var qId = el.getAttribute("data-question-id"),
              ans = localStorage.getItem(prefix + qId);
            answersObj[qId] = ans !== null ? ans : "";
          });
        return answersObj;
      }

      function updateSubmitButton() {
        var count = Object.keys(collectAllAnswers()).length,
          btn = document.getElementById("submitBtn");
        if (count === totalQuestions) {
          btn.disabled = false;
          btn.className = "btn-enabled";
        } else {
          btn.disabled = true;
          btn.className = "btn-disabled";
        }
      }

      function restoreAlternatives() {
        document
          .querySelectorAll(".alternative-container")
          .forEach(function (container) {
            var qId = container.getAttribute("data-questao"),
              saved = localStorage.getItem(
                "aluno_" +
                  alunoId +
                  "_simulado_" +
                  simuladoId +
                  "_questao_" +
                  qId
              );
            if (saved) {
              container
                .querySelectorAll(".alternative-toggle")
                .forEach((el) => el.classList.remove("alternative-selected"));
              var sel = container.querySelector(
                '.alternative-toggle[data-alternative="' + saved + '"]'
              );
              if (sel) sel.classList.add("alternative-selected");
            }
          });
        markAnsweredQuestions();
        updateSubmitButton();
      }

      document
        .querySelectorAll(".alternative-container")
        .forEach(function (el) {
          el.addEventListener("click", function () {
            var q = el.getAttribute("data-questao");
            document
              .querySelectorAll(
                '.alternative-container[data-questao="' +
                  q +
                  '"] .alternative-toggle'
              )
              .forEach((s) => s.classList.remove("alternative-selected"));
            var tog = el.querySelector(".alternative-toggle"),
              alt = tog.getAttribute("data-alternative");
            tog.classList.add("alternative-selected");
            localStorage.setItem(
              "aluno_" + alunoId + "_simulado_" + simuladoId + "_questao_" + q,
              alt
            );
            markAnsweredQuestions();
            updateSubmitButton();
          });
        });

      window.addEventListener("load", restoreAlternatives);
      window.addEventListener("pageshow", restoreAlternatives);

      function markAnsweredQuestions() {
        document
          .querySelectorAll(".sidebar .question-map div")
          .forEach(function (el) {
            var qId = el.getAttribute("data-question-id"),
              key =
                "aluno_" +
                alunoId +
                "_simulado_" +
                simuladoId +
                "_questao_" +
                qId;
            if (localStorage.getItem(key) !== null)
              el.classList.add("answered");
            else el.classList.remove("answered");
          });
      }

      // Timer e encerramento
      var startKey = "aluno_" + alunoId + "_simulado_start_time_" + simuladoId,
        storedStart = localStorage.getItem(startKey) || Date.now();
      localStorage.setItem(startKey, storedStart);

      function formatTime(sec) {
        var h = Math.floor(sec / 3600),
          m = Math.floor((sec % 3600) / 60),
          s = sec % 60;
        return (
          (h < 10 ? "0" : "") +
          h +
          ":" +
          (m < 10 ? "0" : "") +
          m +
          ":" +
          (s < 10 ? "0" : "") +
          s
        );
      }
      function updateTimer() {
        var elapsed = Math.floor((Date.now() - storedStart) / 1000),
          left = examTimeInSeconds - elapsed;
        document.getElementById("timer").textContent =
          "Tempo restante: " + formatTime(left);
        if (left <= 0) {
          clearInterval(timerInterval);
          Swal.fire({
            title: "Tempo esgotado",
            text: "O tempo acabou! Simulado encerrado.",
            icon: "warning",
            confirmButtonColor: "#2563eb",
            confirmButtonText: "Ok",
          }).then(() => {
            examEnded = true;
            localStorage.removeItem(startKey);
            document.getElementById("answersInput").value = JSON.stringify(
              collectAllAnswers()
            );
            var timeoutInput = document.createElement("input");
            timeoutInput.type = "hidden";
            timeoutInput.name = "timeout";
            timeoutInput.value = "true";
            document
              .getElementById("encerrarSimuladoForm")
              .appendChild(timeoutInput);
            document.getElementById("encerrarSimuladoForm").submit();
          });
        }
      }
      var timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      // Envio com confirmação
      document
        .getElementById("encerrarSimuladoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          var answers = collectAllAnswers(),
            count = Object.keys(answers).length;
          document.getElementById("answersInput").value =
            JSON.stringify(answers);
          if (count < totalQuestions) {
            Swal.fire({
              title: "Atenção!",
              text: "Você precisa responder todas as questões para encerrar o simulado.",
              icon: "warning",
              confirmButtonColor: "#2563eb",
              confirmButtonText: "Ok",
            });
            return;
          }
          Swal.fire({
            title: "Tem certeza?",
            text: "Ao encerrar, não será possível voltar atrás!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#2563eb",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sim, encerrar simulado",
          }).then((result) => {
            if (result.isConfirmed) {
              examEnded = true;
              e.target.submit();
            }
          });
        });

      // Navegação via sidebar
      document
        .querySelectorAll(".sidebar .question-map div")
        .forEach(function (el) {
          el.addEventListener("click", function () {
            window.location.href =
              "/aluno/responder-simulado/<%= simulado.id %>?page=" +
              el.getAttribute("data-question");
          });
        });
      document.querySelectorAll(".btn-prev, .btn-next").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          enterFullScreenMode();
          window.location.href = btn.getAttribute("data-target");
        });
      });
    </script>
  </body>
</html>
