<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Responder Simulado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/assets/theme-d32f8eb8.css" />
    <style>
      main {
        max-width: 800px;
        margin: auto 0 800px;
      }
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #ccc;
        padding: 20px;
      }
      .question-card {
        margin-bottom: 20px;
      }
      .alternative-container {
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
      }
      .alternative-toggle.alternative-selected {
        background-color: rgb(79 70 229 / var(--tw-bg-opacity));
        color: white;
      }
      .question-index {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background-color: #f1f1f1;
        border-radius: 4px;
        margin-right: 10px;
      }
      footer .nav-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
      }
      .btn-custom {
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-custom:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .alternative-toggle {
        flex-shrink: 0;
      }
      .alternative-text {
        padding-left: 10px;
        flex-grow: 1;
      }
      .map-popover {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 20px;
        z-index: 1000;
        width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
      }
      .map-popover.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
      }
      .map-popover header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .map-popover .map {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .map-popover .map div {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        cursor: pointer;
      }
      .map-popover .map div.answered {
        background-color: #28a745;
        color: #fff;
      }
      .map-popover .close-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .map-toggle-btn {
        position: fixed;
        bottom: 100px;
        right: 20px;
        padding: 10px 15px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        z-index: 1000;
      }
      #timer {
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="min-h-screen flex flex-col lg:ps-64 w-full">
      <main class="p-6 space-y-2">
        <!-- Exibição do timer persistente -->
        <div id="timer">Tempo restante: --:--:--</div>
        <div class="container">
          <% if (questoes && questoes.length > 0) { %> <% var questao =
          questoes[currentPage - 1]; %>
          <div
            class="question-card card-simulado shadow rounded-lg bg-white dark:bg-default-50 border"
          >
            <header class="d-flex align-items-baseline px-3 py-3">
              <div class="d-flex align-items-center">
                <div class="question-index"><%= currentPage %></div>
              </div>
            </header>
            <div class="px-3 pb-3">
              <div class="mt-2">
                <div class="font-size-2"><%- questao.enunciado %></div>
                <div class="d-flex flex-column mt-3">
                  <% var alternativas = { A: questao.alternativa_a, B:
                  questao.alternativa_b, C: questao.alternativa_c, D:
                  questao.alternativa_d, E: questao.alternativa_e }; %> <%
                  Object.keys(alternativas).forEach(function(key) { %> <% if
                  (alternativas[key]) { %>
                  <div
                    class="alternative-container p-3 my-2"
                    data-questao="<%= questao.id %>"
                  >
                    <div
                      class="alternative-toggle text-center font-weight-bold"
                      data-alternative="<%= key %>"
                      style="
                        font-weight: bold;
                        width: 40px;
                        height: 40px;
                        line-height: 40px;
                        border: 1.5px solid
                          hsl(
                            var(--twc-primary) /
                              var(--twc-primary-opacity, var(--tw-bg-opacity))
                          );
                        border-radius: 50%;
                      "
                    >
                      <%= key %>
                    </div>
                    <div class="alternative-text"><%= alternativas[key] %></div>
                  </div>
                  <% } %> <% }); %>
                </div>
              </div>
            </div>
          </div>
          <% } else { %>
          <div class="text-center text-base text-gray-700">
            Nenhuma questão encontrada.
          </div>
          <% } %>
        </div>
      </main>
      <!-- Footer com navegação -->
      <footer>
        <div class="nav-buttons">
          <% if (currentPage > 1) { %>
          <button
            type="button"
            class="btn-custom"
            onclick="window.location.href='/aluno/responder-simulado/<%= simulado.id %>?page=<%= currentPage - 1 %>'"
          >
            Anterior
          </button>
          <% } else { %>
          <button type="button" class="btn-custom" disabled>Anterior</button>
          <% } %> <% if (currentPage < totalPages) { %>
          <button
            type="button"
            class="btn-custom"
            onclick="window.location.href='/aluno/responder-simulado/<%= simulado.id %>?page=<%= currentPage + 1 %>'"
          >
            Próxima
          </button>
          <% } else { %>
          <button type="button" class="btn-custom" disabled>Próxima</button>
          <% } %>
        </div>
      </footer>
    </div>

    <!-- Botão fixo para alternar a exibição do mapa de questões -->
    <button class="map-toggle-btn" id="mapToggleBtn">Mapa de Questões</button>

    <!-- Popover do mapa de questões com animação -->
    <div class="map-popover" id="mapPopover">
      <header>
        <span>Mapa de Questões</span>
        <button class="close-btn" id="closeMapPopover">&times;</button>
      </header>
      <div class="map">
        <% questoes.forEach(function(q, index) { %>
        <div data-question="<%= index + 1 %>" data-question-id="<%= q.id %>">
          <%= index + 1 %>
        </div>
        <% }); %>
      </div>
      <div style="margin-top: 20px; text-align: center">
        <!-- Formulário para encerrar o simulado via POST -->
        <form
          id="encerrarSimuladoForm"
          method="POST"
          action="/aluno/encerrar-simulado/<%= simulado.id %>"
        >
          <!-- Campo oculto para enviar as respostas -->
          <input type="hidden" name="answers" id="answersInput" value="" />
          <button type="submit" class="btn btn-primary">
            Encerrar simulado
          </button>
        </form>
      </div>
    </div>

    <script>
      // Variáveis necessárias: ID do simulado e do aluno
      var simuladoId = "<%= simulado.id %>";
      var alunoId = "<%= aluno.id %>"; // Certifique-se de que o ID do aluno está disponível no template

      // --- Timer persistente ---
      var examTimeInSeconds = Number("<%= simulado.tempo_prova %>");
      var storedStartTimeKey =
        "aluno_" + alunoId + "_simulado_start_time_" + simuladoId;
      var storedStartTime = localStorage.getItem(storedStartTimeKey);
      if (!storedStartTime) {
        storedStartTime = Date.now();
        localStorage.setItem(storedStartTimeKey, storedStartTime);
      } else {
        storedStartTime = parseInt(storedStartTime, 10);
      }

      function formatTime(seconds) {
        var h = Math.floor(seconds / 3600);
        var m = Math.floor((seconds % 3600) / 60);
        var s = seconds % 60;
        return (
          (h < 10 ? "0" : "") +
          h +
          ":" +
          (m < 10 ? "0" : "") +
          m +
          ":" +
          (s < 10 ? "0" : "") +
          s
        );
      }

      var timerElement = document.getElementById("timer");

      function updateTimer() {
        var elapsedSeconds = Math.floor((Date.now() - storedStartTime) / 1000);
        var timeLeft = examTimeInSeconds - elapsedSeconds;
        timerElement.innerHTML = "Tempo restante: " + formatTime(timeLeft);
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert("O tempo acabou! O simulado será encerrado.");
          localStorage.removeItem(storedStartTimeKey);
          // Se o tempo acabar, forçamos o envio do formulário
          document.getElementById("encerrarSimuladoForm").submit();
        }
      }
      var timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      // --- Função para atualizar o estado do botão de Encerrar ---
      function updateEncerrarButtonState() {
        var answeredCount = 0;
        var totalQuestions = document.querySelectorAll(
          ".map-popover .map div"
        ).length;
        document
          .querySelectorAll(".map-popover .map div")
          .forEach(function (el) {
            var qId = el.getAttribute("data-question-id");
            var key =
              "aluno_" +
              alunoId +
              "_simulado_" +
              simuladoId +
              "_questao_" +
              qId;
            if (localStorage.getItem(key) !== null) {
              answeredCount++;
            }
          });
        // Atualiza os botões de encerrar, se existirem
        // Neste exemplo, o botão do formulário já é usado para envio via POST.
      }

      // --- Função para restaurar a seleção de alternativas ---
      function restoreAlternatives() {
        document
          .querySelectorAll(".alternative-container")
          .forEach(function (container) {
            var qId = container.getAttribute("data-questao");
            var key =
              "aluno_" +
              alunoId +
              "_simulado_" +
              simuladoId +
              "_questao_" +
              qId;
            var saved = localStorage.getItem(key);
            if (saved) {
              container
                .querySelectorAll(".alternative-toggle")
                .forEach(function (elem) {
                  elem.classList.remove("alternative-selected");
                });
              var selected = container.querySelector(
                '.alternative-toggle[data-alternative="' + saved + '"]'
              );
              if (selected) {
                selected.classList.add("alternative-selected");
              }
            }
          });
        markAnsweredQuestions();
      }

      // --- Seleção de alternativas ---
      document
        .querySelectorAll(".alternative-container")
        .forEach(function (el) {
          el.addEventListener("click", function () {
            var currentQuestao = el.getAttribute("data-questao");
            document
              .querySelectorAll(
                '.alternative-container[data-questao="' +
                  currentQuestao +
                  '"] .alternative-toggle'
              )
              .forEach(function (sibling) {
                sibling.classList.remove("alternative-selected");
              });
            var toggle = el.querySelector(".alternative-toggle");
            toggle.classList.add("alternative-selected");
            var alternative = toggle.getAttribute("data-alternative");
            var key =
              "aluno_" +
              alunoId +
              "_simulado_" +
              simuladoId +
              "_questao_" +
              currentQuestao;
            localStorage.setItem(key, alternative);
            markAnsweredQuestions();
          });
        });

      window.addEventListener("load", restoreAlternatives);
      window.addEventListener("pageshow", restoreAlternatives);

      // --- Função para marcar as questões respondidas no mapa ---
      function markAnsweredQuestions() {
        document
          .querySelectorAll(".map-popover .map div")
          .forEach(function (el) {
            var qId = el.getAttribute("data-question-id");
            var key =
              "aluno_" +
              alunoId +
              "_simulado_" +
              simuladoId +
              "_questao_" +
              qId;
            if (localStorage.getItem(key) !== null) {
              el.classList.add("answered");
            } else {
              el.classList.remove("answered");
            }
          });
        updateEncerrarButtonState();
      }

      // --- Intercepta o submit do formulário para incluir as respostas do localStorage ---
      document
        .getElementById("encerrarSimuladoForm")
        .addEventListener("submit", function (e) {
          // Previne o comportamento padrão para inserirmos os dados primeiro
          // e depois permitir o envio.
          e.preventDefault();
          var answersObj = {};
          // Seleciona todas as alternativas disponíveis (pode iterar sobre os containers)
          document
            .querySelectorAll(".alternative-container")
            .forEach(function (container) {
              var qId = container.getAttribute("data-questao");
              var key =
                "aluno_" +
                alunoId +
                "_simulado_" +
                simuladoId +
                "_questao_" +
                qId;
              var answer = localStorage.getItem(key);
              if (answer) {
                answersObj[qId] = answer;
              }
            });
          // Converte o objeto em JSON e coloca no campo oculto
          document.getElementById("answersInput").value =
            JSON.stringify(answersObj);
          // Agora, envia o formulário
          this.submit();
        });

      // --- Alterna exibição do popover do mapa de questões com animação ---
      const mapToggleBtn = document.getElementById("mapToggleBtn");
      const mapPopover = document.getElementById("mapPopover");
      const closeMapPopover = document.getElementById("closeMapPopover");

      mapToggleBtn.addEventListener("click", function () {
        mapPopover.classList.toggle("active");
      });

      closeMapPopover.addEventListener("click", function () {
        mapPopover.classList.remove("active");
      });

      // --- Navega para a questão correspondente ao clicar no número do mapa ---
      document.querySelectorAll(".map-popover .map div").forEach((el) => {
        el.addEventListener("click", () => {
          const questionNum = el.getAttribute("data-question");
          window.location.href =
            "/aluno/responder-simulado/<%= simulado.id %>?page=" + questionNum;
        });
      });
    </script>
  </body>
</html>
