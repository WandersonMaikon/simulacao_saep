<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Adicionar Simulado - Simulação Saep</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="assets/favicon-8fd74f43.ico" />
    <link rel="stylesheet" href="assets/theme-d32f8eb8.css" />
    <!-- Choices.js CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <!-- SweetAlert2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <!-- Bootstrap CSS (opcional para estrutura e botões) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Choices.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <style>
      .modal-overlay {
        z-index: 9999;
      }
      .swal2-container {
        z-index: 100000 !important;
      }
      /* Estilos para o formulário multi-etapas */
      fieldset {
        display: none;
        border: 0;
        padding: 0;
        margin: 0;
      }
      fieldset.active {
        display: block;
      }
      .step-header {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .btn-group-steps {
        margin-top: 1.5rem;
      }
      /* Barra de progresso simples */
      #progressbar {
        height: 20px;
        margin-bottom: 1.5rem;
      }
      #progress-step {
        height: 100%;
        background-color: #4f46e5; /* cor primária */
        width: 25%; /* 4 etapas => 25% por etapa */
        transition: width 0.4s ease;
      }
    </style>
  </head>
  <body class="bg-primary/10">
    <%- include('partials/sidebar') %>
    <div class="min-h-screen flex flex-col lg:ps-64 w-full">
      <%- include('partials/header') %>
      <div class="p-6 space-y-6">
        <!-- Cabeçalho -->
        <div class="flex items-center justify-between w-full print:hidden">
          <h4 class="text-lg font-semibold text-default-900">
            Adicionar Simulado - Multi Step
          </h4>
        </div>
        <!-- Barra de Progresso -->
        <div id="progressbar" class="progress">
          <div id="progress-step" class="progress-bar"></div>
        </div>
        <!-- Formulário Multi-Etapas -->
        <div class="shadow rounded-lg bg-white dark:bg-default-50 p-5">
          <form
            id="form-cadastrar-simulado"
            action="/cadastrar-simulado-steps"
            method="POST"
          >
            <!-- Etapa 1: Selecionar Turma -->
            <fieldset class="active">
              <div class="step-header">Etapa 1: Selecione a Turma</div>
              <div class="mb-3">
                <label for="select-turma" class="form-label">Turma</label>
                <select
                  name="turma"
                  id="select-turma"
                  class="form-select"
                  required
                >
                  <option value="">Selecione uma turma</option>
                  <% if (typeof turmas !== 'undefined' && turmas.length > 0) {
                  %> <% turmas.forEach(function(turma) { %>
                  <option value="<%= turma.id %>"><%= turma.nome %></option>
                  <% }); %> <% } else { %>
                  <option value="">Nenhuma turma disponível</option>
                  <% } %>
                </select>
              </div>
              <div class="btn-group-steps d-flex justify-content-end">
                <button type="button" class="btn btn-primary next">
                  Próximo
                </button>
              </div>
            </fieldset>
            <!-- Etapa 2: Selecionar Alunos -->
            <fieldset>
              <div class="step-header">Etapa 2: Selecione os Alunos</div>
              <div class="mb-3">
                <label for="select-alunos" class="form-label">Alunos</label>
                <select
                  name="alunos[]"
                  id="select-alunos"
                  class="form-select"
                  multiple
                  required
                >
                  <!-- Exemplo: as opções podem ser carregadas via AJAX ou inseridas aqui -->
                  <option value="1">Aluno 1</option>
                  <option value="2">Aluno 2</option>
                  <option value="3">Aluno 3</option>
                  <option value="4">Aluno 4</option>
                </select>
              </div>
              <div class="btn-group-steps d-flex justify-content-between">
                <button type="button" class="btn btn-secondary prev">
                  Voltar
                </button>
                <button type="button" class="btn btn-primary next">
                  Próximo
                </button>
              </div>
            </fieldset>
            <!-- Etapa 3: Selecionar Questões -->
            <fieldset>
              <div class="step-header">Etapa 3: Selecione as Questões</div>
              <div class="mb-3">
                <label for="select-questoes" class="form-label">Questões</label>
                <select
                  name="questoes[]"
                  id="select-questoes"
                  class="form-select"
                  multiple
                  required
                >
                  <!-- Exemplo: as opções podem ser carregadas via AJAX ou inseridas aqui -->
                  <option value="1">Questão 1</option>
                  <option value="2">Questão 2</option>
                  <option value="3">Questão 3</option>
                  <option value="4">Questão 4</option>
                </select>
              </div>
              <div class="btn-group-steps d-flex justify-content-between">
                <button type="button" class="btn btn-secondary prev">
                  Voltar
                </button>
                <button type="button" class="btn btn-primary next">
                  Próximo
                </button>
              </div>
            </fieldset>
            <!-- Etapa 4: Revisão e Confirmação -->
            <fieldset>
              <div class="step-header">Etapa 4: Revisão e Confirmação</div>
              <div class="mb-3">
                <p id="resumo-turma"><strong>Turma:</strong></p>
                <p id="resumo-alunos"><strong>Alunos:</strong></p>
                <p id="resumo-questoes"><strong>Questões:</strong></p>
              </div>
              <div class="btn-group-steps d-flex justify-content-between">
                <button type="button" class="btn btn-secondary prev">
                  Voltar
                </button>
                <button type="submit" class="btn btn-success">
                  Confirmar Cadastro
                </button>
              </div>
            </fieldset>
          </form>
        </div>
      </div>
      <%- include('partials/footer') %>
    </div>

    <!-- Scripts: jQuery já incluído acima; Bootstrap Bundle (opcional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      $(document).ready(function () {
        var currentIndex = 0;
        var fieldsets = $("form fieldset");
        var totalSteps = fieldsets.length;

        // Função para mostrar a etapa atual e atualizar a barra de progresso
        function showStep(index) {
          fieldsets.removeClass("active");
          fieldsets.eq(index).addClass("active");
          var percent = ((index + 1) / totalSteps) * 100;
          $("#progress-step").css("width", percent + "%");

          // Se for a última etapa, atualiza o resumo
          if (index === totalSteps - 1) {
            var turma = $("#select-turma option:selected").text();
            var alunos = $("#select-alunos option:selected")
              .map(function () {
                return $(this).text();
              })
              .get()
              .join(", ");
            var questoes = $("#select-questoes option:selected")
              .map(function () {
                return $(this).text();
              })
              .get()
              .join(", ");
            $("#resumo-turma").html("<strong>Turma:</strong> " + turma);
            $("#resumo-alunos").html("<strong>Alunos:</strong> " + alunos);
            $("#resumo-questoes").html(
              "<strong>Questões:</strong> " + questoes
            );
          }
        }

        $(".next").click(function () {
          // Validação simples para campos obrigatórios da etapa atual
          var valid = true;
          var currentFieldset = fieldsets.eq(currentIndex);
          currentFieldset.find("select[required]").each(function () {
            if (
              !$(this).val() ||
              ($(this).attr("multiple") ? $(this).val().length === 0 : false)
            ) {
              valid = false;
              Swal.fire({
                icon: "warning",
                title: "Atenção",
                text: "Preencha os campos obrigatórios!",
              });
              return false;
            }
          });
          if (!valid) return false;
          currentIndex++;
          if (currentIndex >= totalSteps) currentIndex = totalSteps - 1;
          showStep(currentIndex);
        });

        $(".prev").click(function () {
          currentIndex--;
          if (currentIndex < 0) currentIndex = 0;
          showStep(currentIndex);
        });

        // Inicializa a primeira etapa
        showStep(currentIndex);

        // Inicializa Choices.js para os selects
        new Choices("#select-turma", { removeItemButton: false });
        new Choices("#select-alunos", { removeItemButton: true });
        new Choices("#select-questoes", { removeItemButton: true });
      });
    </script>
  </body>
</html>
