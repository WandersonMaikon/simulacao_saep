<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - Análise Geral</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Inclusão do Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Inclusão do ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="/assets/theme-d32f8eb8.css" />
    <style>
      body {
        background-color: #f0f0f0;
      }
      .title {
        font-size: 2rem;
        font-weight: bold;
      }
      .card-custom {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        background-color: #fff;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }
      /* Outros estilos conforme necessário */
      #donut_chart,
      #bar_chart {
        min-height: 287px;
      }
      #student_chart {
        min-height: 350px;
      }
      /* Novo gráfico de Simulados */
      #simulado_chart {
        min-height: 365px;
      }
    </style>
  </head>
  <body>
    <!-- Inclusão do Sidebar -->
    <%- include('partials/sidebar') %>

    <div class="min-h-screen flex flex-col lg:ps-64 w-full">
      <!-- Inclusão do Header -->
      <%- include('partials/header') %>

      <!-- Conteúdo principal -->
      <div class="container my-5">
        <!-- Formulário de Filtro -->
        <div class="mb-4">
          <form method="GET" action="/admin/dashboard" class="row g-3">
            <div class="col-md-4">
              <label for="curso" class="form-label">Selecione o Curso</label>
              <select class="form-select" name="curso" id="curso" required>
                <option value="">-- Escolha um Curso --</option>
                <% cursos.forEach(cursoItem => { %>
                  <option value="<%= cursoItem.id %>" <% if(cursoFiltro == cursoItem.id) { %> selected <% } %>>
                    <%= cursoItem.nome %>
                  </option>
                <% }); %>
              </select>
            </div>
            <div class="col-md-4">
              <label for="turma" class="form-label">Selecione a Turma</label>
              <select class="form-select" name="turma" id="turma" required>
                <option value="">-- Escolha uma Turma --</option>
                <% if (turmas && turmas.length > 0) { %>
                  <% turmas.forEach(turmaItem => { %>
                    <option value="<%= turmaItem.id %>" <% if(turmaFiltro == turmaItem.id) { %> selected <% } %>>
                      <%= turmaItem.nome %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
            </div>
            <div class="col-md-4 align-self-end">
              <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
          </form>
        </div>

        <!-- Título da Página -->
        <h2 class="title mb-3">Análise Geral</h2>

        <!-- Card para o Gráfico de Simulados (Média das Notas dos Simulados) -->
        <div class="card-custom chart-card">
          <div class="card-header">
            <h5>Desempenho dos Simulados</h5>
          </div>
          <div class="card-body">
            <div id="simulado_chart"></div>
          </div>
        </div>

        <!-- Container oculto para dados dos gráficos -->
        <div
          id="chart-data"
          data-uc-labels='<%= JSON.stringify(performanceData.ucLabels) %>'
          data-acertos='<%= JSON.stringify(performanceData.acertosData) %>'
          data-erros='<%= JSON.stringify(performanceData.errosData) %>'
          data-student-labels='<%= JSON.stringify(performanceData.studentLabels || []) %>'
          data-student-grades='<%= JSON.stringify(performanceData.studentGrades || []) %>'
          data-class-average='<%= performanceData.classAverage || 0 %>'
          data-simulados='<%= JSON.stringify(performanceData.simuladosData || []) %>'
        ></div>
      </div>

      <!-- Inclusão do Footer -->
      <%- include('partials/footer') %>
    </div>

    <!-- Inclusão do Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para atualizar o dropdown de Turma via AJAX -->
    <script>
      document.getElementById("curso").addEventListener("change", function () {
        const cursoId = this.value;
        const turmaSelect = document.getElementById("turma");
        turmaSelect.innerHTML = '<option value="">Carregando turmas...</option>';

        if (!cursoId) {
          turmaSelect.innerHTML = '<option value="">-- Escolha uma Turma --</option>';
          return;
        }

        fetch(`/admin/turmas/by-curso/${cursoId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.turmas && data.turmas.length > 0) {
              let options = '<option value="">-- Escolha uma Turma --</option>';
              data.turmas.forEach((turma) => {
                options += `<option value="${turma.id}">${turma.nome}</option>`;
              });
              turmaSelect.innerHTML = options;
            } else {
              turmaSelect.innerHTML = '<option value="">Nenhuma turma encontrada</option>';
            }
          })
          .catch((error) => {
            console.error("Erro ao carregar turmas:", error);
            turmaSelect.innerHTML = '<option value="">Erro ao carregar turmas</option>';
          });
      });
    </script>

    <!-- Script para renderizar os gráficos -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ---------------------------
        // Gráfico de Simulados: Média das Notas dos Simulados com evento de clique
        // ---------------------------
        var dataEl = document.getElementById("chart-data");
        var simuladosData = JSON.parse(dataEl.getAttribute("data-simulados"));
        // Extrai os títulos e as médias dos simulados
        var simuladosTitles = simuladosData.map(function (item) {
          return item.titulo;
        });
        var simuladosAverages = simuladosData.map(function (item) {
          return Number(item.media) || 0;
        });

        var simuladosChartOptions = {
          chart: {
            type: "bar",
            height: 365,
            events: {
              dataPointSelection: function (event, chartContext, config) {
                // Obtém o índice da barra clicada e o simulado correspondente
                var index = config.dataPointIndex;
                var simulado = simuladosData[index];
                if (simulado && simulado.id) {
                  // Redireciona para a página de detalhes do simulado
                  window.location.href = "/admin/simulados/" + simulado.id;
                }
              }
            }
          },
          series: [
            {
              name: "Média",
              data: simuladosAverages
            }
          ],
          xaxis: {
            categories: simuladosTitles
          },
          title: {
            text: "Média das Notas dos Simulados",
            align: "center"
          },
          yaxis: {
            title: { text: "Nota Média" }
          },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: "55%",
              endingShape: "rounded"
            }
          },
          dataLabels: { enabled: true }
        };

        var simuladosChart = new ApexCharts(
          document.querySelector("#simulado_chart"),
          simuladosChartOptions
        );
        simuladosChart.render();

        // Outros gráficos (Donut, Bar, etc.) podem ser renderizados aqui, se necessário.
      });
    </script>
  </body>
</html>
